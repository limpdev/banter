# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  # ── Binary name ──────────────────────────────────────────────────────────
  APP_NAME: "banter"
  GOOS:
    sh: go env GOOS
  GOARCH:
    sh: go env GOARCH
  # Built-in Go command that returns ".exe" on Windows, and "" on Mac/Linux
  EXT:
    sh: go env GOEXE
  BIN_DIR: "./bin"
  DIST_DIR: "./dist"
  BINARY: "{{.BIN_DIR}}/{{.APP_NAME}}{{.EXT}}"

  # ── MISC ─────────────────────────────────────────────────────────────────
  PKG_PREFIX: "{{.MODULE}}/internal/version"
  LDFLAGS: >-
    -s -w
    -X '{{.PKG_PREFIX}}.Commit={{.GIT_COMMIT}}'
  GO_CMD: "go"
  MODULE:
    sh: go list -m 2>/dev/null || echo "unknown"
  GIT_COMMIT:
    sh: git rev-parse --short HEAD 2>/dev/null || echo "unknown"

  #  CUSTOM VARIABLES
  SUMEXT: "**/*.go,**/*.html,**/*.css,**/*.yml"
  IGNOREXT: ".secrets"

env:
  CGO_ENABLED: "0" # safe default; override per-task if needed

# ---------------------------------------------------------------------------
tasks:
  default:
    desc: "Show available tasks"
    silent: true
    cmds:
      - task --list

  build:
    desc: "Build for the current OS/arch ({{.GOOS}}/{{.GOARCH}})"
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - >-
        {{.GO_CMD}} build
        -trimpath
        -ldflags "{{.LDFLAGS}}"
        -o {{.BINARY}}
        .
    generates:
      - "{{.BINARY}}"
    sources:
      - "**/*.go"
      - "go.mod"
      - "go.sum"

  build:darwin:
    desc: "Cross-compile → darwin/arm64 (Apple Silicon)"
    env:
      GOOS: darwin
      GOARCH: arm64
      CGO_ENABLED: "0"
    cmds:
      - mkdir -p {{.DIST_DIR}}
      - >-
        {{.GO_CMD}} build
        -trimpath
        -ldflags "{{.LDFLAGS}}"
        -o {{.DIST_DIR}}/{{.APP_NAME}}-darwin-arm64
        .

  build:windows:
    desc: "Cross-compile → windows/amd64"
    env:
      GOOS: windows
      GOARCH: amd64
      CGO_ENABLED: "0"
    cmds:
      - mkdir -p {{.DIST_DIR}}
      - >-
        {{.GO_CMD}} build
        -trimpath
        -ldflags "{{.LDFLAGS}}"
        -o {{.DIST_DIR}}/{{.APP_NAME}}-windows-amd64.exe
        .

  build:all:
    desc: "Cross-compile for all supported platforms → dist/"
    deps:
      - build:darwin
      - build:windows
    cmds:
      - echo "✅ All platform binaries written to {{.DIST_DIR}}/"

  run:
    desc: "Build & run (pass args with -- <args>)"
    deps: [build]
    cmds:
      - "{{.BINARY}} {{.CLI_ARGS}}"

  # ── CUSTOM ─────────────────────────────────────────────────────────
  sum:
    desc: "Runs repomix with scoped output"
    silent: true
    cmds:
      - repomix --output "{{.APP_NAME}}.xml" --include "{{.SUMEXT}}" --ignore "{{.IGNOREXT}}"
