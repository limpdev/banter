# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"
# ---------------------------------------------------------------------------
# System-aware variables â€” resolved at runtime, not at parse time.
# ---------------------------------------------------------------------------
vars:
  # â”€â”€ Binary name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  APP_NAME: "app"
  # â”€â”€ OS / Arch detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  GOOS:
    sh: go env GOOS
  GOARCH:
    sh: go env GOARCH
  # Binary extension on Windows
  EXT:
    sh: |
      if [ "$(go env GOOS)" = "windows" ]; then echo ".exe"; else echo ""; fi
  # â”€â”€ Output paths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  BIN_DIR: "./bin"
  DIST_DIR: "./dist"
  BINARY: "{{.BIN_DIR}}/{{.APP_NAME}}{{.EXT}}"
  # â”€â”€ Common ldflags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  PKG_PREFIX: "{{.MODULE}}/internal/version"
  LDFLAGS: >-
    -s -w
    -X '{{.PKG_PREFIX}}.Version={{.VERSION}}'
    -X '{{.PKG_PREFIX}}.Commit={{.GIT_COMMIT}}'
    -X '{{.PKG_PREFIX}}.BuildTime={{.BUILD_TIME}}'
  # â”€â”€ Go tooling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  GO_CMD: "go"
  GOFLAGS: ""
  # â”€â”€ Test config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  TEST_FLAGS: "-race -timeout 120s"
  COVERAGE_OUT: "./coverage.out"
  COVERAGE_HTML: "./coverage.html"
  # â”€â”€ Module / package â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  MODULE:
    sh: go list -m 2>/dev/null || echo "unknown"
  GIT_COMMIT:
    sh: git rev-parse --short HEAD 2>/dev/null || echo "unknown"
  GIT_TAG:
    sh: git describe --tags --exact-match 2>/dev/null || echo ""
  VERSION:
    sh: |
      tag=$(git describe --tags --exact-match 2>/dev/null)
      [ -n "$tag" ] && echo "$tag" || echo "dev-$(git rev-parse --short HEAD 2>/dev/null || echo unknown)"
  BUILD_TIME:
    sh: date -u +"%Y-%m-%dT%H:%M:%SZ"
  # ï’‹ CUSTOM VARIABLES
  SUMEXT: "**/*.go,**/*.html,**/*.css,**/*.yml"
  IGNOREXT: ".secrets"

env:
  CGO_ENABLED: "0" # safe default; override per-task if needed
  GOFLAGS: "{{.GOFLAGS}}"
# ---------------------------------------------------------------------------
# Tasks
# ---------------------------------------------------------------------------
tasks:
  # â”€â”€ Default â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  opts:
    desc: "Show available tasks"
    silent: true
    cmds:
      - task --list
  # â”€â”€ Build (host OS/arch) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    desc: "Build for the current OS/arch ({{.GOOS}}/{{.GOARCH}})"
    vars:
      BINARY: "{{.BIN_DIR}}/{{.APP_NAME}}{{.EXT}}"
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - >-
        {{.GO_CMD}} build
        -trimpath
        -ldflags "{{.LDFLAGS}}"
        -o {{.BINARY}}
        ./...
    generates:
      - "{{.BINARY}}"
    sources:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
  # â”€â”€ Build (debug â€” with symbols, race detector, no trimpath) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:debug:
    desc: "Build a debug binary (symbols retained, race detector enabled)"
    vars:
      BINARY_DBG: "{{.BIN_DIR}}/{{.APP_NAME}}-debug{{.EXT}}"
    env:
      CGO_ENABLED: "1" # race detector needs cgo
    cmds:
      - mkdir -p {{.BIN_DIR}}
      - >-
        {{.GO_CMD}} build
        -race
        -gcflags "all=-N -l"
        -ldflags "{{.LDFLAGS}}"
        -o {{.BINARY_DBG}}
        ./...
  # â”€â”€ Cross-compile helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:darwin:
    desc: "Cross-compile â†’ darwin/arm64 (Apple Silicon)"
    env:
      GOOS: darwin
      GOARCH: arm64
      CGO_ENABLED: "0"
    cmds:
      - mkdir -p {{.DIST_DIR}}
      - >-
        {{.GO_CMD}} build
        -trimpath
        -ldflags "{{.LDFLAGS}}"
        -o {{.DIST_DIR}}/{{.APP_NAME}}-darwin-arm64
        ./...
  build:windows:
    desc: "Cross-compile â†’ windows/amd64"
    env:
      GOOS: windows
      GOARCH: amd64
      CGO_ENABLED: "0"
    cmds:
      - mkdir -p {{.DIST_DIR}}
      - >-
        {{.GO_CMD}} build
        -trimpath
        -ldflags "{{.LDFLAGS}}"
        -o {{.DIST_DIR}}/{{.APP_NAME}}-windows-amd64.exe
        ./...
  build:all:
    desc: "Cross-compile for all supported platforms â†’ dist/"
    deps:
      - build:linux
      - build:linux:arm64
      - build:darwin
      - build:darwin:arm64
      - build:windows
    cmds:
      - echo "âœ…  All platform binaries written to {{.DIST_DIR}}/"
  run:
    desc: "Build & run (pass args with -- <args>)"
    deps: [build]
    cmds:
      - "{{.BINARY}} {{.CLI_ARGS}}"

  # â”€â”€ Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    desc: "Run the full test suite"
    env:
      CGO_ENABLED: "1" # -race requires cgo
    cmds:
      - "{{.GO_CMD}} test {{.TEST_FLAGS}} ./..."
  test:short:
    desc: "Run tests without the race detector (faster)"
    cmds:
      - "{{.GO_CMD}} test -short -timeout 60s ./..."
  test:coverage:
    desc: "Run tests and produce HTML coverage report"
    env:
      CGO_ENABLED: "1"
    cmds:
      - >-
        {{.GO_CMD}} test {{.TEST_FLAGS}}
        -coverprofile={{.COVERAGE_OUT}}
        -covermode=atomic
        ./...
      - "{{.GO_CMD}} tool cover -html={{.COVERAGE_OUT}} -o {{.COVERAGE_HTML}}"
      - echo "ðŸ“Š  Coverage report: {{.COVERAGE_HTML}}"
  test:bench:
    desc: "Run benchmarks"
    cmds:
      - "{{.GO_CMD}} test -run='^$' -bench=. -benchmem ./..."

  # â”€â”€ Lint / vet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  vet:
    desc: "Run go vet"
    cmds:
      - "{{.GO_CMD}} vet ./..."
  lint:
    desc: "Run golangci-lint (installs if missing)"
    cmds:
      - |
        if ! command -v golangci-lint &>/dev/null; then
          echo "â¬‡ï¸  Installing golangci-lint {{.GOLANGCI_VERSION}} â€¦"
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@{{.GOLANGCI_VERSION}}
        fi
      - golangci-lint run ./...
  lint:fix:
    desc: "Run golangci-lint with auto-fix"
    cmds:
      - golangci-lint run --fix ./...

  # â”€â”€ Format â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fmt:
    desc: "Format all Go source files"
    cmds:
      - "{{.GO_CMD}} fmt ./..."
      - |
        if command -v goimports &>/dev/null; then
          goimports -w .
        fi
  fmt:check:
    desc: "Check formatting (non-zero exit if changes needed)"
    cmds:
      - |
        unformatted=$(gofmt -l .)
        if [ -n "$unformatted" ]; then
          echo "âŒ  Unformatted files:"
          echo "$unformatted"
          exit 1
        fi
        echo "âœ…  All files formatted"

  # â”€â”€ Module management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  tidy:
    desc: "go mod tidy"
    cmds:
      - "{{.GO_CMD}} mod tidy"
  deps:upgrade:
    desc: "Upgrade all direct dependencies to latest"
    cmds:
      - "{{.GO_CMD}} get -u ./..."
      - "{{.GO_CMD}} mod tidy"
  deps:verify:
    desc: "Verify module checksums"
    cmds:
      - "{{.GO_CMD}} mod verify"

  # â”€â”€ Code generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  generate:
    desc: "Run go generate across the project"
    cmds:
      - "{{.GO_CMD}} generate ./..."

  # â”€â”€ Security â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  vuln:
    desc: "Run govulncheck (installs if missing)"
    cmds:
      - |
        if ! command -v govulncheck &>/dev/null; then
          go install golang.org/x/vuln/cmd/govulncheck@latest
        fi
      - govulncheck ./...

  # â”€â”€ Clean â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  clean:
    desc: "Remove build artefacts"
    cmds:
      - rm -rf {{.BIN_DIR}} {{.DIST_DIR}} {{.COVERAGE_OUT}} {{.COVERAGE_HTML}}
      - "{{.GO_CMD}} clean -cache -testcache"
  clean:all:
    desc: "Deep clean including module cache"
    deps: [clean]
    cmds:
      - "{{.GO_CMD}} clean -modcache"

  # â”€â”€ CI shorthand â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    desc: "Full CI pipeline: tidy â†’ vet â†’ fmt:check â†’ test â†’ build"
    cmds:
      - task: tidy
      - task: vet
      - task: fmt:check
      - task: test
      - task: build
  info:
    desc: "Print resolved build variables"
    silent: true
    cmds:
      - echo "App       : {{.APP_NAME}}"
      - echo "Module    : {{.MODULE}}"
      - echo "Version   : {{.VERSION}}"
      - echo "Commit    : {{.GIT_COMMIT}}"
      - echo "BuildTime : {{.BUILD_TIME}}"
      - echo "Host OS   : {{.GOOS}}/{{.GOARCH}}"
      - echo "Binary    : {{.BINARY}}"
      - echo "Go        : $(go version)"

  # â”€â”€ CUSTOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sum:
    desc: "Runs repomix with scoped output"
    silent: true
    cmds:
      - repomix --output "{{.APP_NAME}}.xml" --include "{{.SUMEXT}}" --ignore "{{.IGNOREXT}}"